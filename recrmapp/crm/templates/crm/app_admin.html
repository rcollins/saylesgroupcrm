{% extends 'crm/base.html' %}
{% load crm_filters %}
{% block title %}Application Admin{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'crm:home' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Application Admin</li>
    </ol>
</nav>

<h1 class="page-title mb-4">Application Admin</h1>
<p class="text-muted small mb-4">Configure application name, logo, chart colors, and choice lists. Email signatures are set per user in <a href="{% url 'crm:profile' %}">Profile</a>. Changes apply across the app immediately.</p>

<div class="card card-crm mb-4">
    <div class="card-header">
        <h5 class="mb-0 section-title">Application name & logo</h5>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'crm:app_admin' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="form_type" value="settings">
            {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="id_app_name" class="form-label">Application name</label>
                    <input type="text" name="app_name" value="{{ form.app_name.value }}" class="form-control" id="id_app_name" maxlength="100" required>
                </div>
                <div class="col-md-6">
                    <label for="id_logo" class="form-label">Logo (image)</label>
                    <input type="file" name="logo" class="form-control" id="id_logo" accept="image/*">
                    {% if app_settings.logo_url %}
                    <p class="small text-muted mt-1 mb-0">Current: <a href="{{ app_settings.logo_url }}" target="_blank">View logo</a></p>
                    {% endif %}
                    <div class="form-check mt-2">
                        <input type="checkbox" name="clear_logo" id="id_clear_logo" class="form-check-input" value="1">
                        <label class="form-check-label" for="id_clear_logo">Remove logo</label>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Chart colors (hex, e.g. #1e4976)</label>
                <p class="form-text small text-muted mb-2">Used for Buyer / Seller / Dual series on the dashboard income and sales charts.</p>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label small text-muted">Buyer</label>
                        <input type="text" name="buyer_color" value="{{ form.buyer_color.initial }}" class="form-control" placeholder="#1e4976">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted">Seller</label>
                        <input type="text" name="seller_color" value="{{ form.seller_color.initial }}" class="form-control" placeholder="#137333">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted">Dual</label>
                        <input type="text" name="dual_color" value="{{ form.dual_color.initial }}" class="form-control" placeholder="#b45309">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="id_inactivity_timeout_minutes" class="form-label">Inactivity logout (App Admin page)</label>
                <input type="number" name="inactivity_timeout_minutes" value="{{ form.inactivity_timeout_minutes.value|default:form.inactivity_timeout_minutes.initial|default:0 }}" class="form-control" id="id_inactivity_timeout_minutes" min="0" max="120" style="max-width:6rem">
                <p class="form-text small text-muted mb-0">Minutes of no mouse/keyboard activity before logging out on this page. Use 0 to disable.</p>
            </div>
            <button type="submit" class="btn btn-crm-primary">Save application settings</button>
        </form>
    </div>
</div>

<div class="card card-crm mb-4">
    <div class="card-header">
        <h5 class="mb-0 section-title">Status & choice lists</h5>
        <p class="section-subtitle mb-0">Add, edit, or remove options for client status, lead status, contact type, etc.</p>
    </div>
    <div class="card-body">
        {% for list_type, label in list_type_choices %}
        <div id="list-{{ list_type }}" class="mb-4 pb-4 {% if not forloop.last %}border-bottom border-secondary border-opacity-10{% endif %}">
            <h6 class="fw-600 mb-2">{{ label }}</h6>
            <div class="table-responsive mb-2">
                <table class="table table-sm table-crm align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Label</th>
                            <th>Order</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in choice_lists|get_item:list_type %}
                        <tr>
                            <td><code class="small">{{ item.code }}</code></td>
                            <td>{{ item.label }}</td>
                            <td>{{ item.order }}</td>
                            <td class="text-end">
                                <a href="{% url 'crm:app_admin_choice_edit' item.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                                <form method="post" action="{% url 'crm:app_admin_choice_delete' item.pk %}" class="d-inline" onsubmit="return confirm('Remove this choice? Existing records keeping this value will show the code until updated.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-muted small">No entries yet. Add one below.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <form method="post" action="{% url 'crm:app_admin_choice_add' %}" class="row g-2 align-items-end">
                {% csrf_token %}
                <input type="hidden" name="list_type" value="{{ list_type }}">
                <div class="col-auto">
                    <label class="form-label small mb-0">Code</label>
                    <input type="text" name="code" class="form-control form-control-sm" placeholder="e.g. active" maxlength="50" required>
                </div>
                <div class="col-auto">
                    <label class="form-label small mb-0">Label</label>
                    <input type="text" name="label" class="form-control form-control-sm" placeholder="Display label" maxlength="100" required>
                </div>
                <div class="col-auto">
                    <label class="form-label small mb-0">Order</label>
                    <input type="number" name="order" class="form-control form-control-sm" value="0" min="0" style="width:4rem">
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-crm-primary">Add</button>
                </div>
            </form>
        </div>
        {% endfor %}
    </div>
</div>

{% if inactivity_timeout_minutes %}
{# Hidden form for inactivity logout (POST with CSRF) #}
<form id="app-admin-logout-form" method="post" action="{% url 'logout' %}" class="d-none">{% csrf_token %}</form>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if inactivity_timeout_minutes %}
<script>
(function() {
  var timeoutMinutes = {{ inactivity_timeout_minutes|default:0 }};
  if (timeoutMinutes <= 0) return;
  var timeoutMs = timeoutMinutes * 60 * 1000;
  var timer = null;
  var form = document.getElementById('app-admin-logout-form');

  function resetTimer() {
    if (timer) clearTimeout(timer);
    timer = setTimeout(function() {
      if (form) form.submit();
    }, timeoutMs);
  }

  function onActivity() {
    resetTimer();
  }

  ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(function(ev) {
    document.addEventListener(ev, onActivity);
  });
  resetTimer();
})();
</script>
{% endif %}
{% endblock %}
