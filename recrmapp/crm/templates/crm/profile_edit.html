{% extends 'crm/base.html' %}
{% block title %}Profile{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'crm:home' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Profile</li>
    </ol>
</nav>

<h1 class="page-title mb-4">Profile</h1>
<p class="text-muted small mb-4">Manage your account: email signature, optional Mailchimp or Constant Contact connection, and change password.</p>

<div class="card card-crm mb-4">
    <div class="card-header">
        <h5 class="mb-0 section-title">Email signature</h5>
        <p class="section-subtitle mb-0">This HTML is appended to emails you send from the app (clients, contacts, leads, transactions).</p>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'crm:profile' %}" enctype="multipart/form-data">
            {% csrf_token %}
            {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
            <div class="mb-3">
                <label for="id_email_signature" class="form-label">Signature (HTML)</label>
                <p class="form-text small text-muted mb-2">Use <code>&lt;a href="url"&gt;link text&lt;/a&gt;</code> for links and <code>&lt;img src="https://..." alt="..."&gt;</code> for images (use a full image URL).</p>
                <textarea name="email_signature" class="form-control font-monospace" rows="8" id="id_email_signature" placeholder="e.g. &lt;p&gt;Best regards,&lt;br&gt;{{ user.get_username }}&lt;/p&gt;">{% if form.email_signature.value %}{{ form.email_signature.value }}{% else %}{{ form.initial.email_signature|default:"" }}{% endif %}</textarea>
                {% if form.email_signature.errors %}<div class="invalid-feedback d-block">{{ form.email_signature.errors }}</div>{% endif %}
            </div>
            <div class="mb-3">
                <label for="id_signature_image" class="form-label">Signature image (optional)</label>
                <p class="form-text small text-muted mb-2">Upload an image (e.g. logo or headshot) to show at the end of your signature.</p>
                <input type="file" name="signature_image" class="form-control" id="id_signature_image" accept="image/*">
                {% if form.instance.signature_image %}
                <p class="small text-muted mt-1 mb-0">Current: <a href="{{ form.instance.signature_image.url }}" target="_blank">View image</a></p>
                <div class="form-check mt-2">
                    <input type="checkbox" name="clear_signature_image" id="id_clear_signature_image" class="form-check-input" value="1">
                    <label class="form-check-label" for="id_clear_signature_image">Remove signature image</label>
                </div>
                {% endif %}
            </div>
            <hr class="my-4">
            <h6 class="fw-600 mb-3">Email marketing (optional)</h6>
            <p class="form-text small text-muted mb-3">Connect one service to sync contacts for newsletters. Different agents can use Mailchimp or Constant Contact. Leave blank if you don't use either.</p>
            <div class="row g-3">
                <div class="col-md-6">
                    <p class="small fw-600 text-muted mb-2">Mailchimp {% if form.instance.has_mailchimp_connected %}<span class="badge bg-success">Connected</span>{% endif %}</p>
                    <div class="mb-2">
                        <label for="id_mailchimp_api_key" class="form-label small">API key</label>
                        <input type="password" name="mailchimp_api_key" class="form-control" id="id_mailchimp_api_key" placeholder="Leave blank to keep current" autocomplete="off">
                        <p class="form-text small mb-0">Account → Extras → API keys</p>
                    </div>
                    <div>
                        <label for="id_mailchimp_audience_id" class="form-label small">Audience (list) ID</label>
                        <input type="text" name="mailchimp_audience_id" value="{{ form.mailchimp_audience_id.value|default:form.initial.mailchimp_audience_id|default:'' }}" class="form-control" id="id_mailchimp_audience_id" placeholder="e.g. abc123def4">
                        <p class="form-text small mb-0">Audience → Settings → Audience ID</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <p class="small fw-600 text-muted mb-2">Constant Contact {% if form.instance.has_constant_contact_connected %}<span class="badge bg-success">Connected</span>{% endif %}</p>
                    <div class="mb-2">
                        <label for="id_constant_contact_api_key" class="form-label small">App Key (client ID)</label>
                        <input type="text" name="constant_contact_api_key" value="{{ form.constant_contact_api_key.value|default:form.initial.constant_contact_api_key|default:'' }}" class="form-control" id="id_constant_contact_api_key" placeholder="From developer portal">
                    </div>
                    <div class="mb-2">
                        <label for="id_constant_contact_api_secret" class="form-label small">App Secret</label>
                        <input type="password" name="constant_contact_api_secret" class="form-control" id="id_constant_contact_api_secret" placeholder="Leave blank to keep current" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="id_constant_contact_access_token" class="form-label small">Access token</label>
                        <input type="password" name="constant_contact_access_token" class="form-control" id="id_constant_contact_access_token" placeholder="Leave blank to keep current" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="id_constant_contact_refresh_token" class="form-label small">Refresh token</label>
                        <input type="password" name="constant_contact_refresh_token" class="form-control" id="id_constant_contact_refresh_token" placeholder="Leave blank to keep current" autocomplete="off">
                    </div>
                    <div>
                        <label for="id_constant_contact_list_id" class="form-label small">List ID</label>
                        <input type="text" name="constant_contact_list_id" value="{{ form.constant_contact_list_id.value|default:form.initial.constant_contact_list_id|default:'' }}" class="form-control" id="id_constant_contact_list_id" placeholder="Required for sync">
                        <p class="form-text small mb-0">List to add synced contacts to</p>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-crm-primary mt-3">Save profile</button>
        </form>
    </div>
</div>

<div class="card card-crm mb-4">
    <div class="card-header">
        <h5 class="mb-0 section-title">Newsletter sync</h5>
        <p class="section-subtitle mb-0">Push opted-in clients, leads, and contacts to Mailchimp or Constant Contact.</p>
    </div>
    <div class="card-body">
        <p class="mb-0">After connecting a service above, sync your opted-in contacts to your list.</p>
        <a href="{% url 'crm:email_marketing_sync' %}" class="btn btn-crm-primary mt-2"><i class="bi bi-envelope me-1"></i>Go to sync page</a>
    </div>
</div>

<div class="card card-crm mb-4">
    <div class="card-header">
        <h5 class="mb-0 section-title">Change password</h5>
    </div>
    <div class="card-body">
        <p class="mb-0">Use the link below to change your account password.</p>
        <a href="{% url 'password_change' %}" class="btn btn-outline-primary mt-2"><i class="bi bi-key me-1"></i>Change password</a>
    </div>
</div>
{% endblock %}
